<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Product Details</title>
  <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f9f9f9;
    }

    header {
      background: linear-gradient(to right, #4b0082, #800080);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.4em;
      position: relative;
    }

    .logo {
      font-weight: bold;
    }

    .cart-icon {
      position: relative;
      text-decoration: none;
      color: white;
      font-size: 1.4em;
    }

    .cart-count {
      position: absolute;
      top: 5px;
      right: 10px;
      background: red;
      color: white;
      font-size: 0.7em;
      border-radius: 50%;
      padding: 2px 6px;
    }

    #product-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      max-width: 1000px;
      margin: 30px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
    }

    .image-gallery {
      flex: 1;
      min-width: 300px;
    }

    .main-image {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      border: 1px solid #ddd;
      border-radius: 10px;
      cursor: zoom-in;
    }

    .thumbnails {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .thumbnails img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      cursor: pointer;
      border: 2px solid transparent;
      border-radius: 5px;
    }

    .thumbnails img.active {
      border-color: orange;
    }

    .details {
      flex: 1;
      min-width: 300px;
    }

    .price {
      font-size: 1.2em;
      margin-bottom: 15px;
    }

    .price .current {
      color: green;
      font-weight: bold;
      margin-right: 10px;
    }

    .price .original {
      text-decoration: line-through;
      color: #999;
      margin-right: 10px;
    }

    .price .discount {
      color: red;
      font-weight: bold;
    }

    .sizes span {
      display: inline-block;
      padding: 6px 12px;
      border: 1px solid #ddd;
      margin: 5px 5px 10px 0;
      border-radius: 5px;
      cursor: pointer;
    }

    .sizes span.selected {
      background-color: orange;
      color: white;
      border-color: orange;
    }

    .actions {
      margin-top: 15px;
    }

    .actions button {
      margin-right: 10px;
      padding: 10px 20px;
      font-size: 1em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .add-cart {
      background: orange;
      color: white;
    }

    .buy-now {
      background: green;
      color: white;
    }

    footer {
      background: linear-gradient(to right, #4b0082, #800080);
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 0.95em;
      margin-top: 40px;
    }

    .lightbox {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      display: none;
      z-index: 9999;
    }

    .lightbox img {
      max-width: 90%;
      max-height: 90%;
      border-radius: 10px;
    }

    @media (max-width: 768px) {
      #product-container {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">Ask My Shoe</div>
  <a href="cart.html" class="cart-icon">ðŸ›’<span id="cart-count" class="cart-count">0</span></a>
</header>

<div id="product-container">Loading product...</div>

<div class="lightbox" id="lightbox" onclick="this.style.display='none'">
  <img id="lightbox-img" src="">
</div>

<footer>
  <p><strong>Contact Details</strong></p>
  <p>Email: Askmyshoe@gmail.com</p>
  <p>Phone: 0720380374</p>
  <p>Facebook: Ask my shoe KE</p>
  <p>TikTok: @Askmyshoeke</p>
</footer>

<script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
<script>
  const APP_ID = "0889EC61-CC4A-4B8E-BD71-C27140B34E26";
  const API_KEY = "63AB1DF8-175A-48B6-8F9C-EE24F2E58F21";
  const FILES_BASE_URL = `https://api.backendless.com/${APP_ID}/${API_KEY}/files/products-images/`;

  Backendless.initApp(APP_ID, API_KEY);

  function getProductIdFromURL() {
    return new URLSearchParams(window.location.search).get("id");
  }

  function calculateDiscount(original, current) {
    if (!original || original <= current) return '';
    const discount = ((original - current) / original) * 100;
    return `-${Math.round(discount)}%`;
  }

  function normalizeImages(imagesRaw) {
    if (!imagesRaw) return [];
    try {
      const parsed = typeof imagesRaw === 'string' ? JSON.parse(imagesRaw) : imagesRaw;
      if (Array.isArray(parsed)) {
        return parsed.map(img => img.startsWith("http") ? img : FILES_BASE_URL + img);
      } else if (typeof parsed === 'string') {
        return [parsed.startsWith("http") ? parsed : FILES_BASE_URL + parsed];
      }
    } catch {
      return [imagesRaw.startsWith("http") ? imagesRaw : FILES_BASE_URL + imagesRaw];
    }
    return [];
  }

  function createImageGallery(images) {
    if (!images.length) return '<p>No image found</p>';
    const mainImage = `<img src="${images[0]}" class="main-image" id="mainImage" onclick="zoomImage('${images[0]}')">`;
    const thumbnails = images.map((img, i) => `
      <img src="${img}" class="${i === 0 ? 'active' : ''}" onclick="changeMainImage('${img}', this)">`
    ).join('');
    return `${mainImage}<div class="thumbnails">${thumbnails}</div>`;
  }

  function changeMainImage(src, element) {
    document.getElementById("mainImage").src = src;
    document.querySelectorAll(".thumbnails img").forEach(img => img.classList.remove("active"));
    element.classList.add("active");
  }

  function zoomImage(src) {
    document.getElementById("lightbox-img").src = src;
    document.getElementById("lightbox").style.display = "flex";
  }

  function renderProduct(product) {
    const imageUrls = normalizeImages(product.images || product.image || []);
    const discount = calculateDiscount(product.originalprice, product.currentprice);
    const sizes = (product.size || "").split(',');
    const sizeOptions = sizes.map(size =>
      `<span onclick="selectSize(this)">${size.trim()}</span>`).join('');

    document.getElementById("product-container").innerHTML = `
      <div class="image-gallery">
        ${createImageGallery(imageUrls)}
      </div>
      <div class="details">
        <h1>${product.productname}</h1>
        <div class="price">
          <span class="current">KES ${product.currentprice}</span>
          <span class="original">${product.originalprice ? `KES ${product.originalprice}` : ''}</span>
          <span class="discount">${discount}</span>
        </div>
        <div class="sizes">${sizeOptions}</div>
        <div class="actions">
          <button class="add-cart" onclick="addToCart(${JSON.stringify({
            objectId: product.objectId,
            name: product.productname,
            price: product.currentprice,
            image: imageUrls[0],
            quantity: 1
          })})">Add to Cart</button>
          <button class="buy-now">Buy Now</button>
        </div>
        <div class="tab">
          <h3>Description</h3>
          <p>${product.description || 'No description provided.'}</p>
        </div>
      </div>`;
  }

  function selectSize(el) {
    document.querySelectorAll(".sizes span").forEach(s => s.classList.remove("selected"));
    el.classList.add("selected");
  }

  function addToCart(product) {
    const selectedSize = document.querySelector(".sizes span.selected");
    if (!selectedSize) {
      alert("Please select a size before adding to cart.");
      return;
    }
    product.size = selectedSize.innerText;

    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    const existing = cart.find(item => item.objectId === product.objectId && item.size === product.size);
    if (existing) {
      existing.quantity += 1;
    } else {
      cart.push(product);
    }
    localStorage.setItem("cart", JSON.stringify(cart));
    updateCartCount();
    alert(`${product.name} (Size ${product.size}) added to cart`);
  }

  function updateCartCount() {
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    const total = cart.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById("cart-count").innerText = total;
  }

  async function loadProduct() {
    const id = getProductIdFromURL();
    if (!id) return document.getElementById("product-container").innerHTML = "<p class='error'>Product ID missing</p>";
    try {
      const product = await Backendless.Data.of("Products").findById(id);
      renderProduct(product);
    } catch (err) {
      console.error(err);
      document.getElementById("product-container").innerHTML = "<p class='error'>Failed to load product</p>";
    }
  }

  loadProduct();
  updateCartCount();
</script>

</body>
</html>
