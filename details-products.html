<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product Details</title>
  <script src="https://api.backendless.com/sdk/js/latest/backendless.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    /* Custom styles to match the previous design feel, as Tailwind might be too minimal */
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    h1, h2, h3, p { margin: 0; padding: 0; }
    .product-grid { display: grid; gap: 2rem; }
    @media (min-width: 768px) { .product-grid { grid-template-columns: repeat(2, 1fr); } }
    #mainImage { width: 100%; border-radius: 0.5rem; margin-bottom: 1rem; object-fit: cover; }
    #thumbnails img { border: 2px solid transparent; transition: border-color 0.2s ease; }
    #thumbnails img.border-purple-500 { border-color: #7c3aed; } /* This is Tailwind's purple-500, similar to previous design's purple */
    .bg-purple-600 { background-color: #6b21a8; } /* Matching previous design's button color */
    .hover\:bg-purple-700:hover { background-color: #581c87; } /* Matching previous design's button hover */
  </style>
</head>
<body class="bg-gray-100 text-gray-900">

  <header class="bg-purple-700 text-white p-4 flex justify-between items-center">
    <h1 class="font-bold text-xl">AskMyShoe</h1>
    <button class="bg-white text-purple-700 px-3 py-1 rounded font-semibold">üõí Cart (<span id="cart-count">0</span>)</button>
  </header>

  <div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 bg-white p-6 rounded-lg shadow-md">
      
      <div>
        <img id="mainImage" class="w-full h-auto rounded-lg shadow-sm" src="https://via.placeholder.com/500x500?text=Loading..." alt="Product Image">
        <div id="thumbnails" class="mt-4 flex space-x-2 overflow-x-auto">
          </div>
      </div>

      <div>
        <h1 id="product-name" class="text-3xl font-bold mb-4">Loading Product Details...</h1>
        <p id="product-price" class="text-xl text-green-600 font-semibold mb-2"></p>
        <p id="product-description" class="mb-4 text-gray-700"></p>

        <div class="space-y-2 mb-6 text-gray-800">
          <p><strong>Brand:</strong> <span id="product-brand">N/A</span></p>
          <p><strong>SKU:</strong> <span id="product-sku">N/A</span></p>
          <p><strong>Color:</strong> <span id="product-color">N/A</span></p>
        </div>

        <button onclick="addToCart()" class="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700 transition">Add to Cart</button>
      </div>
    </div>

    <section class="bg-white p-6 rounded-lg shadow-md mt-8">
      <h3 class="text-2xl font-bold mb-4">Additional Details</h3>
      <table class="w-full text-left border-collapse">
        <tbody>
          <tr><th class="py-2 px-4 border-b">Material</th><td id="product-material" class="py-2 px-4 border-b">Loading...</td></tr>
          </tbody>
      </table>
    </section>

    <section class="bg-white p-6 rounded-lg shadow-md mt-8">
      <h3 class="text-2xl font-bold mb-4">Customer Reviews</h3>
      <div class="reviews-header flex items-center gap-2 mb-4">
        <div class="text-yellow-500 text-2xl">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</div>
        <span class="text-gray-600">4.5 out of 5 (120 reviews)</span>
      </div>
      <div>
        <div class="review border-t pt-4 mt-4 first:border-t-0 first:mt-0">
          <p class="font-semibold">Jane M.</p>
          <div class="text-yellow-500 text-lg my-1">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</div>
          <p class="text-sm text-gray-700">Absolutely love these!</p>
        </div>
        <div class="review border-t pt-4 mt-4">
          <p class="font-semibold">Mark K.</p>
          <div class="text-yellow-500 text-lg my-1">‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è</div>
          <p class="text-sm text-gray-700">Good value. Could use more arch support though.</p>
        </div>
      </div>
    </section>

  </div>

  <script>
    // Initialize Backendless
    // IMPORTANT: Double-check your Application ID and JavaScript API Key in Backendless Console
    Backendless.initApp("0889EC61-CC4A-4B8E-BD71-C27140B34E26", "9BB7614B-9F7B-49F0-8C8C-65182EC8EBE3");

    function getProductIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      // Ensure the URL parameter name matches what you use to pass the product ID (e.g., 'id')
      return params.get("id"); 
    }

    function changeImage(imgElement) {
      document.getElementById("mainImage").src = imgElement.src;
      document.querySelectorAll("#thumbnails img").forEach(img => img.classList.remove("border-purple-500"));
      imgElement.classList.add("border-purple-500");
    }

    async function loadProduct() {
      const productId = getProductIdFromURL();
      console.log("DEBUG: Attempting to load product with ID:", productId); 

      if (!productId) {
        document.getElementById("product-name").innerText = "Error: Product ID Missing";
        document.getElementById("product-description").innerText = "This page requires a product ID in the URL (e.g., ?id=YOUR_PRODUCT_ID). Please navigate from the homepage or product listing.";
        document.getElementById("product-price").innerText = "";
        console.error("CRITICAL ERROR: Missing product ID in URL. Please ensure the URL contains '?id=YOUR_PRODUCT_ID'.");
        return;
      }

      try {
        // Step 1: Fetch product details
        // IMPORTANT: Verify the case sensitivity of your "Products" table name in Backendless Console.
        // If your table is named 'products' (lowercase), change 'Products' below to 'products'.
        console.log(`DEBUG: Fetching product from 'Products' table with ID: ${productId}`);
        const product = await Backendless.Data.of("Products").findById(productId);

        if (!product) {
          console.warn("Product not found for ID:", productId);
          document.getElementById("product-name").innerText = "Product Not Found";
          document.getElementById("product-description").innerText = "The product you are looking for could not be found. It might have been removed or the ID is incorrect.";
          document.getElementById("product-price").innerText = "";
          document.getElementById("mainImage").src = "https://via.placeholder.com/500x500?text=Product+Not+Found";
          return;
        }

        // Set product info
        document.getElementById("product-name").innerText = product.name || "N/A";
        // Ensure 'price' exists before calling toFixed, and provide a default
        document.getElementById("product-price").innerText = "KES " + (product.price != null ? product.price.toFixed(2) : "0.00");
        document.getElementById("product-description").innerText = product.description || "No description provided.";
        document.getElementById("product-brand").innerText = product.brand || "Unknown";
        document.getElementById("product-sku").innerText = product.sku || "N/A";
        document.getElementById("product-color").innerText = product.color || "N/A";
        document.getElementById("product-material").innerText = product.material || "N/A";

        console.log("DEBUG: Product details loaded:", product);

        // Step 2: Fetch images from the separate 'Products-Images' table
        // IMPORTANT: Verify the case sensitivity of your "Products-Images" table name in Backendless Console.
        // If your table is named 'products-images' (lowercase), change 'Products-Images' below to 'products-images'.
        // Also, ensure the column linking to the product ID is correctly named (e.g., 'productId')
        const query = Backendless.DataQueryBuilder.create().setWhereClause(`productId = '${productId}'`);
        console.log(`DEBUG: Querying 'Products-Images' table for images linked to productId: ${productId}`);
        const images = await Backendless.Data.of("Products-Images").find(query);

        const mainImage = document.getElementById("mainImage");
        const thumbnails = document.getElementById("thumbnails");
        thumbnails.innerHTML = ""; // Clear existing placeholder content

        if (Array.isArray(images) && images.length > 0) {
          console.log("DEBUG: Images found:", images); 
          // Set the main image and active thumbnail
          mainImage.src = images[0].url; // Assumes image URL is in a 'url' column
          images.forEach((img, index) => {
            const thumb = document.createElement("img");
            thumb.src = img.url; // Assumes image URL is in a 'url' column
            thumb.className = "h-20 w-20 object-cover cursor-pointer rounded border-2 " + (index === 0 ? "border-purple-500" : "border-transparent");
            thumb.alt = `Thumbnail ${index + 1} for ${product.name}`; // Add alt text for accessibility
            thumb.onclick = () => changeImage(thumb);
            thumbnails.appendChild(thumb);
          });
        } else {
          console.warn(`DEBUG: No images found for product ID: ${productId}. Displaying placeholder image.`);
          mainImage.src = "https://via.placeholder.com/500x500?text=No+Image+Available";
          // Optionally, hide the thumbnails div if there are no images
          thumbnails.style.display = 'none'; 
        }

      } catch (err) {
        console.error("CRITICAL ERROR: Failed to load product or images.", err);
        document.getElementById("product-name").innerText = "Error Loading Product";
        document.getElementById("product-description").innerText = "An unexpected error occurred while loading product details. Please check your internet connection, the console for details, and ensure your Backendless table names and column names are correct and case-sensitive.";
        document.getElementById("product-price").innerText = "";
        document.getElementById("mainImage").src = "https://via.placeholder.com/500x500?text=Error+Loading";
        document.getElementById("thumbnails").innerHTML = "<p class='text-red-500'>Error loading images.</p>";
        document.getElementById("product-brand").innerText = "Error";
        document.getElementById("product-sku").innerText = "Error";
        document.getElementById("product-color").innerText = "Error";
        document.getElementById("product-material").innerText = "Error";
      }
    }

    function addToCart() {
      const productId = getProductIdFromURL();
      if (!productId) {
        alert("Cannot add to cart: Product ID is missing.");
        return;
      }
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      const found = cart.find(item => item.id === productId);
      if (found) {
        found.quantity += 1;
      } else {
        cart.push({ id: productId, quantity: 1 });
      }
      localStorage.setItem("cart", JSON.stringify(cart));
      updateCartCount();
      alert("Product added to cart!");
    }

    function updateCartCount() {
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      let count = cart.reduce((sum, item) => sum + item.quantity, 0);
      document.getElementById("cart-count").innerText = count;
    }

    // Call loadProduct when the window loads
    window.onload = () => {
        loadProduct();
        updateCartCount(); 
    };
  </script>
</body>
</html/>         
